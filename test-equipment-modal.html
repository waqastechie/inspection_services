<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Equipment Modal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .equipment-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            border: 1px solid #dee2e6;
            padding: 0.5rem;
            font-size: 0.875rem;
        }
        .equipment-table td {
            border: 1px solid #dee2e6;
            padding: 0.5rem;
            font-size: 0.875rem;
        }
        .equipment-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .item-row:hover {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>Equipment Modal Test</h1>
        
        <!-- Equipment Section -->
        <section class="form-section" id="section-equipment">
            <div class="section-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="section-title mb-0">
                            <i class="fas fa-tools"></i>
                            Equipment & Items
                        </h2>
                        <p class="text-muted">Add equipment types and their inspection items</p>
                    </div>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#equipmentModal">
                        <i class="fas fa-plus me-2"></i>Add Equipment & Items
                    </button>
                </div>
            </div>

            <div class="section-content">
                <!-- Equipment Items Display Table -->
                <div id="equipmentItemsContainer">
                    <div id="noEquipmentMessage" class="alert alert-info text-center">
                        <i class="fas fa-info-circle me-2"></i>
                        No equipment items added yet. Click "Add Equipment & Items" to get started.
                    </div>
                    
                    <div id="equipmentItemsTable" style="display: none;">
                        <table class="equipment-table">
                            <thead>
                                <tr>
                                    <th style="width: 120px;">Serial Number</th>
                                    <th>Description and Identification of Equipment</th>
                                    <th style="width: 80px;">SWL</th>
                                    <th style="width: 100px;">Test Load Applied</th>
                                    <th style="width: 120px;">Reason of Examination</th>
                                    <th style="width: 100px;">Date of Manufacture</th>
                                    <th style="width: 100px;">Date of Last Examination</th>
                                    <th style="width: 100px;">Date of Next Examination</th>
                                    <th style="width: 80px;">Status</th>
                                    <th style="width: 80px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="equipmentItemsBody">
                                <!-- Items will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Hidden input to store all equipment data -->
                <input type="hidden" name="equipment_data" id="equipmentDataInput" value="[]">
            </div>
        </section>

        <!-- Equipment Modal -->
        <div class="modal fade" id="equipmentModal" tabindex="-1" aria-labelledby="equipmentModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="equipmentModalLabel">
                            <i class="fas fa-tools me-2"></i>Add Equipment & Items
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Equipment Type Selection -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="equipmentTypeSelect" class="form-label fw-bold">
                                    <i class="fas fa-layer-group me-2"></i>Equipment Type *
                                </label>
                                <select class="form-select" id="equipmentTypeSelect" required>
                                    <option value="">Select Equipment Type</option>
                                    <!-- Will be populated from equipment_types table -->
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Equipment Type Info</label>
                                <div id="equipmentTypeInfo" class="form-control-plaintext text-muted">
                                    Select an equipment type to see details
                                </div>
                            </div>
                        </div>

                        <!-- Items Section -->
                        <div class="border rounded p-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0"><i class="fas fa-list me-2"></i>Equipment Items</h6>
                                <button type="button" class="btn btn-sm btn-success" onclick="addNewItemRow()">
                                    <i class="fas fa-plus me-1"></i>Add Item
                                </button>
                            </div>

                            <!-- Items Table -->
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 120px;">Serial Number *</th>
                                            <th>Description and Identification *</th>
                                            <th style="width: 80px;">SWL</th>
                                            <th style="width: 100px;">Test Load Applied</th>
                                            <th style="width: 120px;">Reason of Examination</th>
                                            <th style="width: 100px;">Date of Manufacture</th>
                                            <th style="width: 100px;">Date of Last Examination</th>
                                            <th style="width: 100px;">Date of Next Examination</th>
                                            <th style="width: 80px;">Status</th>
                                            <th style="width: 60px;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="itemsTableBody">
                                        <!-- Items will be added here dynamically -->
                                    </tbody>
                                </table>
                            </div>

                            <div id="noItemsMessage" class="text-center text-muted py-3">
                                No items added yet. Click "Add Item" to start.
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveEquipmentItems()">
                            <i class="fas fa-save me-2"></i>Save Equipment & Items
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    let equipmentItems = [];
    let itemCounter = 0;

    // Load equipment types when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadEquipmentTypes();
        updateEquipmentDisplay();
    });

    // Load equipment types from database (mock data for testing)
    function loadEquipmentTypes() {
        // Mock data for testing - normally this would fetch from /api/equipment-types
        const mockData = [
            {id: 1, name: 'Gas Rack', description: 'Gas storage and distribution equipment', category: 'pressure_equipment'},
            {id: 2, name: 'Wire Rope', description: 'Wire rope lifting equipment', category: 'lifting_equipment'},
            {id: 3, name: 'Bow Shackle', description: 'Bow shackle lifting accessory', category: 'lifting_equipment'},
            {id: 4, name: 'Crane Scale', description: 'Weighing equipment for crane operations', category: 'measuring_equipment'},
            {id: 5, name: 'Load Cell', description: 'Force measurement device', category: 'measuring_equipment'},
            {id: 6, name: 'Pressure Gauge', description: 'Pressure measuring instrument', category: 'measuring_equipment'},
            {id: 7, name: 'Torque Wrench', description: 'Torque measurement and application tool', category: 'measuring_equipment'}
        ];

        const select = document.getElementById('equipmentTypeSelect');
        select.innerHTML = '<option value="">Select Equipment Type</option>';
        
        mockData.forEach(type => {
            const option = document.createElement('option');
            option.value = type.id;
            option.textContent = type.name;
            option.dataset.description = type.description || '';
            option.dataset.category = type.category || '';
            select.appendChild(option);
        });
    }

    // Handle equipment type selection
    document.getElementById('equipmentTypeSelect').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const infoDiv = document.getElementById('equipmentTypeInfo');
        
        if (selectedOption.value) {
            infoDiv.innerHTML = `
                <strong>Category:</strong> ${selectedOption.dataset.category}<br>
                <strong>Description:</strong> ${selectedOption.dataset.description}
            `;
        } else {
            infoDiv.innerHTML = 'Select an equipment type to see details';
        }
    });

    // Add new item row
    function addNewItemRow() {
        itemCounter++;
        const tbody = document.getElementById('itemsTableBody');
        const noItemsMsg = document.getElementById('noItemsMessage');
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="text" class="form-control form-control-sm" name="item_serial_${itemCounter}" placeholder="Serial No." required></td>
            <td><input type="text" class="form-control form-control-sm" name="item_description_${itemCounter}" placeholder="Equipment description" required></td>
            <td><input type="text" class="form-control form-control-sm" name="item_swl_${itemCounter}" placeholder="SWL"></td>
            <td><input type="text" class="form-control form-control-sm" name="item_test_load_${itemCounter}" placeholder="Test load"></td>
            <td>
                <select class="form-select form-select-sm" name="item_reason_${itemCounter}">
                    <option value="">Select</option>
                    <option value="A">A - New Installation</option>
                    <option value="B">B - 6 Monthly</option>
                    <option value="C">C - 12 Monthly</option>
                    <option value="D">D - Written Scheme</option>
                    <option value="E">E - Exceptional Circumstances</option>
                </select>
            </td>
            <td><input type="date" class="form-control form-control-sm" name="item_manufacture_date_${itemCounter}"></td>
            <td><input type="date" class="form-control form-control-sm" name="item_last_exam_date_${itemCounter}"></td>
            <td><input type="date" class="form-control form-control-sm" name="item_next_exam_date_${itemCounter}"></td>
            <td>
                <select class="form-select form-select-sm" name="item_status_${itemCounter}">
                    <option value="">Select</option>
                    <option value="ND">ND - No Defects</option>
                    <option value="D">D - Defect Found</option>
                    <option value="NI">NI - Not Inspected</option>
                    <option value="R">R - Rejected</option>
                </select>
            </td>
            <td>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItemRow(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
        noItemsMsg.style.display = 'none';
    }

    // Remove item row
    function removeItemRow(button) {
        const row = button.closest('tr');
        row.remove();
        
        const tbody = document.getElementById('itemsTableBody');
        const noItemsMsg = document.getElementById('noItemsMessage');
        
        if (tbody.children.length === 0) {
            noItemsMsg.style.display = 'block';
        }
    }

    // Save equipment items
    function saveEquipmentItems() {
        const equipmentTypeSelect = document.getElementById('equipmentTypeSelect');
        const equipmentTypeId = equipmentTypeSelect.value;
        const equipmentTypeName = equipmentTypeSelect.options[equipmentTypeSelect.selectedIndex].text;
        
        if (!equipmentTypeId) {
            alert('Please select an equipment type.');
            return;
        }
        
        const tbody = document.getElementById('itemsTableBody');
        const rows = tbody.querySelectorAll('tr');
        
        if (rows.length === 0) {
            alert('Please add at least one item.');
            return;
        }
        
        // Collect all items data
        const newItems = [];
        let hasErrors = false;
        
        rows.forEach((row, index) => {
            const inputs = row.querySelectorAll('input, select');
            const serialNumber = row.querySelector(`[name^="item_serial_"]`).value.trim();
            const description = row.querySelector(`[name^="item_description_"]`).value.trim();
            
            if (!serialNumber || !description) {
                hasErrors = true;
                return;
            }
            
            const item = {
                id: Date.now() + index,
                equipment_type_id: equipmentTypeId,
                equipment_type_name: equipmentTypeName,
                serial_number: serialNumber,
                description: description,
                swl: row.querySelector(`[name^="item_swl_"]`).value,
                test_load_applied: row.querySelector(`[name^="item_test_load_"]`).value,
                reason_for_examination: row.querySelector(`[name^="item_reason_"]`).value,
                date_of_manufacture: row.querySelector(`[name^="item_manufacture_date_"]`).value,
                date_of_last_examination: row.querySelector(`[name^="item_last_exam_date_"]`).value,
                date_of_next_examination: row.querySelector(`[name^="item_next_exam_date_"]`).value,
                status: row.querySelector(`[name^="item_status_"]`).value
            };
            
            newItems.push(item);
        });
        
        if (hasErrors) {
            alert('Please fill in all required fields (Serial Number and Description).');
            return;
        }
        
        // Add items to global array
        equipmentItems = equipmentItems.concat(newItems);
        
        // Update display
        updateEquipmentDisplay();
        
        // Clear modal and close
        resetModal();
        const modal = bootstrap.Modal.getInstance(document.getElementById('equipmentModal'));
        modal.hide();
        
        console.log('Equipment items saved:', equipmentItems);
    }

    // Reset modal
    function resetModal() {
        document.getElementById('equipmentTypeSelect').value = '';
        document.getElementById('equipmentTypeInfo').innerHTML = 'Select an equipment type to see details';
        document.getElementById('itemsTableBody').innerHTML = '';
        document.getElementById('noItemsMessage').style.display = 'block';
    }

    // Update equipment display in main section
    function updateEquipmentDisplay() {
        const container = document.getElementById('equipmentItemsContainer');
        const noMessage = document.getElementById('noEquipmentMessage');
        const table = document.getElementById('equipmentItemsTable');
        const tbody = document.getElementById('equipmentItemsBody');
        
        if (equipmentItems.length === 0) {
            noMessage.style.display = 'block';
            table.style.display = 'none';
            return;
        }
        
        noMessage.style.display = 'none';
        table.style.display = 'block';
        
        // Build table rows
        tbody.innerHTML = '';
        equipmentItems.forEach((item, index) => {
            const row = document.createElement('tr');
            row.className = 'item-row';
            row.innerHTML = `
                <td>${item.serial_number}</td>
                <td>${item.description}<br><small class="text-muted">${item.equipment_type_name}</small></td>
                <td>${item.swl || '-'}</td>
                <td>${item.test_load_applied || '-'}</td>
                <td>${item.reason_for_examination || '-'}</td>
                <td>${item.date_of_manufacture || '-'}</td>
                <td>${item.date_of_last_examination || '-'}</td>
                <td>${item.date_of_next_examination || '-'}</td>
                <td>${item.status || '-'}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeEquipmentItem(${item.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        // Update hidden input
        document.getElementById('equipmentDataInput').value = JSON.stringify(equipmentItems);
    }

    // Remove equipment item
    function removeEquipmentItem(itemId) {
        if (confirm('Are you sure you want to remove this equipment item?')) {
            equipmentItems = equipmentItems.filter(item => item.id !== itemId);
            updateEquipmentDisplay();
        }
    }
    </script>
</body>
</html>